{% extends "base.html" %}

{% block title %}{{ vessel.name }} - Vessel Details{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Vessel Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-ship text-blue-600 mr-3"></i>{{ vessel.name }}
                </h1>
                <div class="flex items-center space-x-4 text-sm text-gray-600">
                    <span><i class="fas fa-anchor mr-1"></i>{{ vessel.vessel_type }}</span>
                    <span><i class="fas fa-map-marker-alt mr-1"></i>{{ vessel.port_of_call }}</span>
                    <span class="px-2 py-1 rounded-full text-xs 
                        {% if vessel.status == 'operations_active' %}bg-green-100 text-green-800
                        {% elif vessel.status == 'berthed' %}bg-blue-100 text-blue-800
                        {% elif vessel.status == 'expected' %}bg-yellow-100 text-yellow-800
                        {% elif vessel.status == 'operations_complete' %}bg-purple-100 text-purple-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ vessel.status.replace('_', ' ').title() }}
                    </span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold text-blue-600">{{ "%.1f"|format(vessel.progress_percentage) }}%</div>
                <div class="text-sm text-gray-500">Complete</div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <i class="fas fa-car text-blue-500 text-2xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">Cargo Capacity</p>
                    <p class="text-xl font-bold">{{ vessel.total_cargo_capacity }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <i class="fas fa-truck text-green-500 text-2xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">Heavy Equipment</p>
                    <p class="text-xl font-bold">{{ vessel.heavy_equipment_count }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <i class="fas fa-users text-orange-500 text-2xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">Drivers Assigned</p>
                    <p class="text-xl font-bold">{{ vessel.drivers_assigned }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <i class="fas fa-van-shuttle text-purple-500 text-2xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">TICO Vehicles</p>
                    <p class="text-xl font-bold">{{ vessel.tico_vehicles_needed }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress and Cargo Tally Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cargo Tally Widget -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-calculator text-blue-600 mr-2"></i>Cargo Tally
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="cargoInput" class="block text-sm font-medium text-gray-700 mb-2">Enter Cargo Count</label>
                        <div class="flex space-x-2">
                            <input type="number" id="cargoInput" min="1" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Number of cars loaded">
                            <button onclick="addCargoTally()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                                Add
                            </button>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Progress</span>
                            <span class="text-sm font-semibold">{{ vessel.get_cargo_loaded() }} / {{ vessel.total_cargo_capacity }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" 
                                 style="width: {{ vessel.progress_percentage }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Tallies -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-list text-green-600 mr-2"></i>Recent Cargo Tallies
                </h2>
                
                <div class="space-y-3" id="tallyList">
                    {% if cargo_tallies %}
                        {% for tally in cargo_tallies %}
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-plus-circle text-green-500 mr-2"></i>
                                <span class="font-semibold">{{ tally.cargo_count }}</span>
                                <span class="text-gray-600 ml-2">cars {{ tally.tally_type }}</span>
                                {% if tally.location %}
                                    <span class="text-sm text-gray-500 ml-2">({{ tally.location }})</span>
                                {% endif %}
                            </div>
                            <div class="text-sm text-gray-500">
                                {{ tally.timestamp.strftime('%H:%M') }}
                                {% if not tally.synced %}
                                    <i class="fas fa-clock text-yellow-500 ml-2" title="Pending sync"></i>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-4"></i>
                            <p>No cargo tallies recorded yet</p>
                            <p class="text-sm">Add your first tally using the widget above</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-8 flex space-x-4">
        <a href="/dashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
        <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
            <i class="fas fa-download mr-2"></i>Export Data
        </button>
    </div>
</div>

<script>
// Cargo tally functionality
function addCargoTally() {
    const input = document.getElementById('cargoInput');
    const count = parseInt(input.value);
    
    if (!count || count <= 0) {
        alert('Please enter a valid cargo count');
        return;
    }
    
    // Add tally via API
    fetch(`/api/vessels/{{ vessel.id }}/cargo-tally`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            cargo_count: count,
            tally_type: 'loaded',
            location: 'deck_1', // Could be made configurable
            timestamp: new Date().toISOString()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI
            addTallyToList(count, 'loaded', new Date());
            updateProgress(data.new_progress);
            input.value = '';
        } else {
            throw new Error(data.error);
        }
    })
    .catch(error => {
        console.error('Tally error:', error);
        
        if (navigator.onLine) {
            alert('Failed to add tally: ' + error.message);
        } else {
            // Save offline and show in UI
            saveTallyOffline(count);
            addTallyToList(count, 'loaded', new Date(), false);
            input.value = '';
            showOfflineMessage();
        }
    });
}

function addTallyToList(count, type, timestamp, synced = true) {
    const tallyList = document.getElementById('tallyList');
    const timeStr = timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    const tallyElement = document.createElement('div');
    tallyElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
    tallyElement.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-plus-circle text-green-500 mr-2"></i>
            <span class="font-semibold">${count}</span>
            <span class="text-gray-600 ml-2">cars ${type}</span>
        </div>
        <div class="text-sm text-gray-500">
            ${timeStr}
            ${!synced ? '<i class="fas fa-clock text-yellow-500 ml-2" title="Pending sync"></i>' : ''}
        </div>
    `;
    
    tallyList.insertBefore(tallyElement, tallyList.firstChild);
}

function updateProgress(newProgress) {
    const progressBar = document.querySelector('.bg-blue-600');
    if (progressBar) {
        progressBar.style.width = newProgress + '%';
    }
}

function saveTallyOffline(count) {
    const offlineTallies = JSON.parse(localStorage.getItem('offlineCargoTallies') || '[]');
    offlineTallies.push({
        vessel_id: {{ vessel.id }},
        cargo_count: count,
        tally_type: 'loaded',
        timestamp: new Date().toISOString(),
        synced: false
    });
    localStorage.setItem('offlineCargoTallies', JSON.stringify(offlineTallies));
}

function showOfflineMessage() {
    const message = document.createElement('div');
    message.className = 'fixed top-20 right-4 bg-yellow-100 border border-yellow-300 rounded-lg p-4 max-w-sm z-50';
    message.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-wifi-slash text-yellow-600 mr-2"></i>
            <span class="text-yellow-800">Tally saved offline. Will sync when connection returns.</span>
        </div>
    `;
    document.body.appendChild(message);
    
    setTimeout(() => {
        message.remove();
    }, 5000);
}

function exportData() {
    // Simple data export functionality
    const vesselData = {
        name: '{{ vessel.name }}',
        type: '{{ vessel.vessel_type }}',
        status: '{{ vessel.status }}',
        progress: {{ vessel.progress_percentage }},
        capacity: {{ vessel.total_cargo_capacity }},
        loaded: {{ vessel.get_cargo_loaded() }},
        timestamp: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(vesselData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `${vesselData.name}_data_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

// Auto-sync offline tallies when connection returns
window.addEventListener('online', () => {
    const offlineTallies = JSON.parse(localStorage.getItem('offlineCargoTallies') || '[]');
    const vesselTallies = offlineTallies.filter(t => t.vessel_id === {{ vessel.id }});
    
    if (vesselTallies.length > 0) {
        console.log('Syncing offline cargo tallies...');
        // Implementation would sync each tally to server
    }
});
</script>
{% endblock %}